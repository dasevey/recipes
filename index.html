<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dave's Recipe Book</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #F5F0E8;
    --warm-white: #FDFAF4;
    --brown: #3D2B1F;
    --brown-mid: #6B4C3B;
    --orange: #C4622D;
    --orange-light: #E8845A;
    --sage: #7A8C6E;
    --sage-light: #B5C4A8;
    --border: #D4C5B0;
    --shadow: rgba(61,43,31,0.12);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--brown); min-height: 100vh; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    background: var(--brown); padding: 20px 40px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 20px var(--shadow);
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--cream); }
  .logo span { color: var(--orange-light); font-style: italic; }
  .nav-btns { display: flex; gap: 10px; }
  .nav-btn {
    background: transparent; border: 1.5px solid rgba(255,255,255,0.3);
    color: var(--cream); padding: 8px 18px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 0.88rem; cursor: pointer; transition: all 0.2s;
  }
  .nav-btn:hover, .nav-btn.active { background: var(--orange); border-color: var(--orange); }
  .nav-btn.add-btn { background: var(--orange); border-color: var(--orange); }
  .nav-btn.add-btn:hover { background: var(--orange-light); border-color: var(--orange-light); }

  /* ‚îÄ‚îÄ Views ‚îÄ‚îÄ */
  .view { display: none; }
  .view.active { display: block; }
  .container { max-width: 960px; margin: 0 auto; padding: 40px 24px; }

  /* ‚îÄ‚îÄ Config bar ‚îÄ‚îÄ */
  .config-bar {
    background: #FFF8F0; border: 1.5px solid #E8C9A0; border-radius: 10px;
    padding: 14px 20px; margin-bottom: 24px; font-size: 0.85rem; color: var(--brown-mid);
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .config-bar.hidden { display: none; }
  .config-input {
    border: 1.5px solid var(--border); border-radius: 6px; padding: 6px 10px;
    font-size: 0.85rem; font-family: 'DM Sans', sans-serif; background: white;
    color: var(--brown); outline: none; flex: 1; min-width: 160px;
  }
  .config-input:focus { border-color: var(--orange); }
  .config-save-btn {
    background: var(--sage); color: white; border: none; padding: 7px 16px;
    border-radius: 6px; font-size: 0.82rem; cursor: pointer; font-family: 'DM Sans', sans-serif; white-space: nowrap;
  }

  /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
  .search-bar {
    background: var(--warm-white); border: 2px solid var(--border); border-radius: 12px;
    padding: 20px 24px; margin-bottom: 32px; display: flex; gap: 16px;
    align-items: center; flex-wrap: wrap; box-shadow: 0 4px 16px var(--shadow);
  }
  .search-label { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--brown-mid); white-space: nowrap; }
  #recipe-search {
    flex: 1; min-width: 200px; border: 1.5px solid var(--border); border-radius: 8px;
    padding: 10px 14px; font-family: 'DM Sans', sans-serif; font-size: 1rem;
    background: var(--cream); color: var(--brown); outline: none; transition: border-color 0.2s;
  }
  #recipe-search:focus { border-color: var(--orange); }
  .search-results { position: relative; flex: 1; min-width: 200px; }
  .dropdown {
    position: absolute; top: 100%; left: 0; right: 0; background: var(--warm-white);
    border: 1.5px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px var(--shadow);
    z-index: 50; max-height: 260px; overflow-y: auto; display: none;
  }
  .dropdown.open { display: block; }
  .dropdown-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; }
  .dropdown-item:last-child { border-bottom: none; }
  .dropdown-item:hover { background: var(--cream); }
  .dropdown-item .recipe-name { font-weight: 500; color: var(--brown); }
  .dropdown-item .recipe-cat { font-size: 0.8rem; color: var(--brown-mid); margin-top: 2px; }

  /* ‚îÄ‚îÄ Recipe Card ‚îÄ‚îÄ */
  .recipe-card { background: var(--warm-white); border-radius: 16px; box-shadow: 0 4px 24px var(--shadow); overflow: hidden; display: none; animation: fadeIn 0.3s ease; }
  .recipe-card.visible { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .recipe-header { background: var(--brown); padding: 32px 40px; color: var(--cream); }
  .recipe-category { font-size: 0.75rem; font-weight: 500; letter-spacing: 0.12em; text-transform: uppercase; color: var(--orange-light); margin-bottom: 8px; }
  .recipe-title { font-family: 'Playfair Display', serif; font-size: 2.2rem; line-height: 1.2; margin-bottom: 12px; }
  .recipe-desc { font-size: 0.95rem; color: #C4B5A5; line-height: 1.6; max-width: 580px; }
  .recipe-actions { display: flex; gap: 10px; margin-top: 18px; }
  .btn-edit {
    background: rgba(255,255,255,0.15); border: 1.5px solid rgba(255,255,255,0.3);
    color: var(--cream); padding: 7px 18px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; transition: background 0.2s;
  }
  .btn-edit:hover { background: rgba(255,255,255,0.25); }
  .btn-delete {
    background: rgba(180,50,50,0.25); border: 1.5px solid rgba(220,80,80,0.4);
    color: #FFB3B3; padding: 7px 18px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; transition: background 0.2s;
  }
  .btn-delete:hover { background: rgba(180,50,50,0.45); }

  /* ‚îÄ‚îÄ Scaler ‚îÄ‚îÄ */
  .scaler-bar {
    background: var(--cream); border-bottom: 1px solid var(--border);
    padding: 16px 40px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .scaler-label { font-size: 0.9rem; color: var(--brown-mid); font-weight: 500; }
  .scaler-controls {
    display: flex; align-items: center; gap: 8px; background: var(--warm-white);
    border: 1.5px solid var(--border); border-radius: 8px; padding: 4px 8px;
  }
  .scaler-btn {
    background: none; border: none; width: 30px; height: 30px; border-radius: 6px;
    font-size: 1.2rem; cursor: pointer; color: var(--orange); font-weight: bold;
    transition: background 0.15s; display: flex; align-items: center; justify-content: center;
  }
  .scaler-btn:hover { background: var(--cream); }
  #serving-count {
    width: 48px; text-align: center; border: none; background: transparent;
    font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; color: var(--brown); outline: none;
  }
  .scaler-note { font-size: 0.82rem; color: var(--brown-mid); font-style: italic; }

  /* ‚îÄ‚îÄ Recipe Body ‚îÄ‚îÄ */
  .recipe-body { display: grid; grid-template-columns: 1fr 1.4fr; gap: 0; }
  @media (max-width: 680px) {
    .recipe-body { grid-template-columns: 1fr; }
    .recipe-header { padding: 24px 20px; }
    .recipe-title { font-size: 1.6rem; }
    .scaler-bar { padding: 14px 20px; }
  }
  .ingredients-panel { padding: 32px 28px 32px 40px; border-right: 1px solid var(--border); }
  .panel-title {
    font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--brown);
    margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--orange); display: inline-block;
  }
  .ingredient-group { margin-bottom: 20px; }
  .group-label { font-size: 0.7rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; color: var(--sage); margin-bottom: 8px; }
  .ingredient-row { display: flex; align-items: baseline; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .ingredient-row:last-child { border-bottom: none; }
  .ing-amount { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 0.95rem; color: var(--orange); min-width: 110px; flex-shrink: 0; }
  .ing-name { font-size: 0.9rem; color: var(--brown); }
  .ing-cut { font-size: 0.8rem; color: var(--brown-mid); font-style: italic; margin-left: 4px; }
  .directions-panel { padding: 32px 40px 32px 28px; }
  .direction-step { display: flex; gap: 16px; margin-bottom: 20px; align-items: flex-start; }
  .step-num {
    background: var(--orange); color: white; width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; margin-top: 2px;
  }
  .step-text { font-size: 0.92rem; line-height: 1.65; color: var(--brown); }
  .recipe-notes { background: var(--cream); border-top: 1px solid var(--border); padding: 20px 40px; font-size: 0.88rem; color: var(--brown-mid); line-height: 1.6; }
  .recipe-notes strong { color: var(--brown); }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state { text-align: center; padding: 80px 20px; color: var(--brown-mid); }
  .empty-state .big-icon { font-size: 3.5rem; margin-bottom: 16px; }
  .empty-state h2 { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 8px; color: var(--brown); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SHOPPING LIST VIEW
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .shop-header { margin-bottom: 32px; }
  .shop-header h1 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--brown); margin-bottom: 6px; }
  .shop-header p { color: var(--brown-mid); font-size: 0.95rem; }

  .recipe-picker {
    background: var(--warm-white); border: 2px solid var(--border); border-radius: 12px;
    padding: 24px; margin-bottom: 28px; box-shadow: 0 4px 16px var(--shadow);
  }
  .picker-title { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: var(--brown); margin-bottom: 16px; }
  .recipe-pick-list { display: flex; flex-direction: column; gap: 10px; }
  .recipe-pick-row {
    display: flex; align-items: center; gap: 14px; padding: 12px 16px;
    border: 1.5px solid var(--border); border-radius: 8px; background: var(--cream);
    transition: border-color 0.2s;
  }
  .recipe-pick-row.selected { border-color: var(--orange); background: #FFF5EE; }
  .pick-checkbox {
    width: 20px; height: 20px; accent-color: var(--orange); cursor: pointer; flex-shrink: 0;
  }
  .pick-name { font-weight: 500; color: var(--brown); flex: 1; cursor: pointer; }
  .pick-cat { font-size: 0.78rem; color: var(--brown-mid); margin-right: 8px; }
  .pick-servings-ctrl { display: flex; align-items: center; gap: 6px; }
  .pick-servings-ctrl label { font-size: 0.82rem; color: var(--brown-mid); }
  .pick-servings-input {
    width: 52px; text-align: center; border: 1.5px solid var(--border); border-radius: 6px;
    padding: 4px 6px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    color: var(--brown); background: white; outline: none;
  }
  .pick-servings-input:focus { border-color: var(--orange); }

  .generate-btn {
    background: var(--orange); color: white; border: none; padding: 13px 32px;
    border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 1rem; font-weight: 500;
    cursor: pointer; transition: background 0.2s; width: 100%; margin-bottom: 28px;
  }
  .generate-btn:hover { background: var(--orange-light); }
  .generate-btn:disabled { background: var(--border); cursor: not-allowed; }

  /* Shopping list output */
  .shopping-list-output { display: none; }
  .shopping-list-output.visible { display: block; }

  .list-toolbar {
    display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between;
  }
  .list-toolbar h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--brown); }
  .toolbar-btns { display: flex; gap: 10px; }
  .toolbar-btn {
    background: none; border: 1.5px solid var(--border); color: var(--brown-mid);
    padding: 7px 16px; border-radius: 6px; font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
  }
  .toolbar-btn:hover { border-color: var(--orange); color: var(--orange); }
  .toolbar-btn.primary { background: var(--sage); border-color: var(--sage); color: white; }
  .toolbar-btn.primary:hover { background: var(--sage-light); }

  .grocery-category {
    background: var(--warm-white); border-radius: 12px; margin-bottom: 16px;
    box-shadow: 0 2px 12px var(--shadow); overflow: hidden;
  }
  .cat-header {
    background: var(--brown); padding: 12px 20px; display: flex; align-items: center; gap: 12px;
  }
  .cat-icon { font-size: 1.1rem; }
  .cat-name { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--cream); flex: 1; }
  .cat-count { font-size: 0.78rem; color: rgba(255,255,255,0.5); }

  .shop-item {
    display: flex; align-items: center; gap: 14px; padding: 13px 20px;
    border-bottom: 1px solid var(--border); transition: background 0.15s; cursor: pointer;
  }
  .shop-item:last-child { border-bottom: none; }
  .shop-item:hover { background: var(--cream); }
  .shop-item.checked { background: #F0F5EE; }
  .shop-check { width: 20px; height: 20px; accent-color: var(--sage); flex-shrink: 0; cursor: pointer; }
  .shop-amount { font-family: 'Playfair Display', serif; font-weight: 700; color: var(--orange); min-width: 130px; font-size: 0.92rem; }
  .shop-name { font-size: 0.92rem; color: var(--brown); flex: 1; }
  .shop-item.checked .shop-name { text-decoration: line-through; color: var(--brown-mid); opacity: 0.6; }
  .shop-item.checked .shop-amount { opacity: 0.4; }
  .shop-recipes { font-size: 0.75rem; color: var(--brown-mid); font-style: italic; }

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(30,18,10,0.6); z-index: 200;
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--warm-white); border-radius: 16px; width: 100%;
    max-width: 600px; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
  }
  @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  .modal-header {
    background: var(--brown); padding: 24px 28px; border-radius: 16px 16px 0 0;
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--cream); }
  .modal-close { background: none; border: none; color: var(--cream); font-size: 1.4rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
  .modal-close:hover { opacity: 1; }
  .modal-body { padding: 28px; }
  .form-group { margin-bottom: 20px; }
  .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--brown-mid); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em; }
  .form-input, .form-textarea, .form-select {
    width: 100%; border: 1.5px solid var(--border); border-radius: 8px; padding: 10px 14px;
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--brown); background: var(--cream); outline: none; transition: border-color 0.2s;
  }
  .form-input:focus, .form-textarea:focus { border-color: var(--orange); }
  .form-textarea { min-height: 100px; resize: vertical; }
  .form-row { display: flex; gap: 12px; }
  .form-row .form-group { flex: 1; }
  .modal-footer { padding: 0 28px 28px; display: flex; gap: 12px; justify-content: flex-end; }
  .btn-cancel {
    background: none; border: 1.5px solid var(--border); color: var(--brown-mid);
    padding: 10px 22px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
  }
  .btn-save {
    background: var(--orange); border: none; color: white; padding: 10px 24px;
    border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500;
  }
  .btn-save:hover { background: var(--orange-light); }
  .status-msg { text-align: center; padding: 10px; border-radius: 8px; font-size: 0.88rem; margin-top: 12px; display: none; }
  .status-msg.success { background: #EDF7ED; color: #2E7D32; display: block; }
  .status-msg.error   { background: #FDECEA; color: #C62828; display: block; }

  /* Confirm Delete */
  .confirm-overlay {
    position: fixed; inset: 0; background: rgba(30,18,10,0.65); z-index: 300;
    display: none; align-items: center; justify-content: center;
  }
  .confirm-overlay.open { display: flex; }
  .confirm-box {
    background: var(--warm-white); border-radius: 12px; padding: 32px 36px;
    max-width: 380px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .confirm-box h3 { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--brown); margin-bottom: 10px; }
  .confirm-box p { font-size: 0.9rem; color: var(--brown-mid); margin-bottom: 24px; line-height: 1.5; }
  .confirm-btns { display: flex; gap: 12px; justify-content: center; }
  .confirm-cancel { background: none; border: 1.5px solid var(--border); color: var(--brown-mid); padding: 9px 22px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; }
  .confirm-delete { background: #C0392B; border: none; color: white; padding: 9px 22px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 500; }
  .confirm-delete:hover { background: #E74C3C; }
</style>
</head>
<body>

<header>
  <div class="logo">Dave's <span>Recipe Book</span></div>
  <div class="nav-btns">
    <button class="nav-btn active" id="nav-recipes" onclick="showView('recipes')">üìñ Recipes</button>
    <button class="nav-btn" id="nav-shopping" onclick="showView('shopping')">üõí Shopping List</button>
    <button class="nav-btn add-btn" onclick="openModal()">+ Add Recipe</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECIPES VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view active" id="view-recipes">
<div class="container">
  <div class="config-bar" id="config-bar">
    <strong>‚öôÔ∏è GitHub Setup:</strong>
    <input class="config-input" id="cfg-owner" placeholder="GitHub username" />
    <input class="config-input" id="cfg-repo" placeholder="Repo name (e.g. recipes)" />
    <input class="config-input" id="cfg-token" placeholder="GitHub personal access token" type="password" />
    <button class="config-save-btn" onclick="saveConfig()">Save Config</button>
  </div>

  <div class="search-bar">
    <span class="search-label">Find a Recipe</span>
    <div class="search-results">
      <input type="text" id="recipe-search" placeholder="Search or type a recipe name..." autocomplete="off" />
      <div class="dropdown" id="dropdown"></div>
    </div>
  </div>

  <div class="recipe-card" id="recipe-card"></div>

  <div class="empty-state" id="empty-state">
    <div class="big-icon">üç≥</div>
    <h2>Search for a recipe above</h2>
    <p>Type a name or scroll through your collection to get started.</p>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOPPING LIST VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="view" id="view-shopping">
<div class="container">
  <div class="shop-header">
    <h1>Shopping List</h1>
    <p>Select recipes and servings, then generate your combined grocery list.</p>
  </div>

  <div class="recipe-picker">
    <div class="picker-title">Select Recipes</div>
    <div class="recipe-pick-list" id="recipe-pick-list"></div>
  </div>

  <button class="generate-btn" id="generate-btn" onclick="generateShoppingList()">Generate Shopping List</button>

  <div class="shopping-list-output" id="shopping-list-output">
    <div class="list-toolbar">
      <h2>Your Shopping List</h2>
      <div class="toolbar-btns">
        <button class="toolbar-btn" onclick="uncheckAll()">Uncheck All</button>
        <button class="toolbar-btn primary" onclick="copyList()">üìã Copy List</button>
      </div>
    </div>
    <div id="grocery-groups"></div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIRM DELETE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box">
    <h3>Delete Recipe?</h3>
    <p id="confirm-msg">Are you sure you want to delete this recipe?</p>
    <div class="confirm-btns">
      <button class="confirm-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="confirm-delete" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD/EDIT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">Add New Recipe</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="f-edit-id" value="" />
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Recipe Name</label>
          <input class="form-input" id="f-name" placeholder="e.g. Baked Salmon II" />
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <input class="form-input" id="f-category" placeholder="e.g. Vegan, Seafood" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Short Description</label>
        <input class="form-input" id="f-desc" placeholder="One or two sentences about the dish" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Base Servings</label>
          <input class="form-input" id="f-servings" type="number" placeholder="e.g. 4" min="1" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ingredients ‚Äî one per line</label>
        <div style="font-size:0.78rem; color:var(--brown-mid); margin-bottom:6px; line-height:1.6;">
          Format: <strong>name | tsp-per-serving | unit | cut | used-in | grocery-category</strong><br>
          Units: <strong>V</strong>=volume &nbsp; <strong>PC</strong>=pieces &nbsp; <strong>CL</strong>=cloves &nbsp; <strong>LB</strong>=pounds &nbsp; <strong>OZ</strong>=ounces &nbsp; <strong>PKG</strong>=packages &nbsp; <strong>GARNISH</strong>=to taste<br>
          Categories: Produce, Proteins, Dairy &amp; Alternatives, Pantry, Canned Goods, Grains, Frozen, Condiments, Beverages &amp; Broths<br>
          Example: <em>olive oil | 3 | V | | Marinade | Pantry</em>
        </div>
        <textarea class="form-textarea" id="f-ingredients" style="min-height:140px;" placeholder="salmon fillets | 1 | PC | | Main | Proteins&#10;olive oil | 3 | V | | Marinade | Pantry&#10;garlic | 1 | CL | minced | Base | Produce"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Directions ‚Äî one step per line</label>
        <textarea class="form-textarea" id="f-directions" placeholder="Preheat oven to 375¬∞F.&#10;Mix marinade ingredients.&#10;Bake for 35-45 minutes."></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Notes (optional)</label>
        <textarea class="form-textarea" id="f-notes" style="min-height:70px;" placeholder="Tips, substitutions, make-ahead advice..."></textarea>
      </div>
      <div id="modal-status" class="status-msg"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveRecipe()">Save Recipe</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let recipes = [];
let currentRecipe = null;
let currentServings = 1;
let githubConfig = JSON.parse(localStorage.getItem('recipe-gh-config') || '{}');

const CATEGORY_ICONS = {
  'Produce': 'ü•¶',
  'Proteins': 'üêü',
  'Dairy & Alternatives': 'ü•õ',
  'Pantry': 'ü´ô',
  'Canned Goods': 'ü•´',
  'Grains': 'üåæ',
  'Frozen': '‚ùÑÔ∏è',
  'Condiments': 'üç∂',
  'Beverages & Broths': 'ü•£',
  'Other': 'üõí'
};

const CATEGORY_ORDER = ['Produce','Proteins','Dairy & Alternatives','Canned Goods','Pantry','Condiments','Grains','Frozen','Beverages & Broths','Other'];

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
  loadConfig();
  await loadRecipes();
  initSearch();
  renderPickList();
});

// ‚îÄ‚îÄ‚îÄ Views ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'shopping') renderPickList();
}

// ‚îÄ‚îÄ‚îÄ GitHub Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadConfig() {
  if (githubConfig.owner) {
    document.getElementById('cfg-owner').value = githubConfig.owner;
    document.getElementById('cfg-repo').value = githubConfig.repo;
    document.getElementById('cfg-token').value = githubConfig.token || '';
    if (githubConfig.owner && githubConfig.repo && githubConfig.token)
      document.getElementById('config-bar').classList.add('hidden');
  }
}

function saveConfig() {
  githubConfig = {
    owner: document.getElementById('cfg-owner').value.trim(),
    repo:  document.getElementById('cfg-repo').value.trim(),
    token: document.getElementById('cfg-token').value.trim(),
  };
  localStorage.setItem('recipe-gh-config', JSON.stringify(githubConfig));
  if (githubConfig.owner && githubConfig.repo && githubConfig.token)
    document.getElementById('config-bar').classList.add('hidden');
  alert('Config saved!');
}

// ‚îÄ‚îÄ‚îÄ Load Recipes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadRecipes() {
  try {
    if (githubConfig.owner && githubConfig.repo) {
      const url = `https://raw.githubusercontent.com/${githubConfig.owner}/${githubConfig.repo}/main/recipes.json`;
      const res = await fetch(url + '?t=' + Date.now());
      if (res.ok) { recipes = await res.json(); return; }
    }
    const res = await fetch('recipes.json?t=' + Date.now());
    if (res.ok) recipes = await res.json();
  } catch(e) { recipes = []; }
  recipes.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
}

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSearch() {
  const input = document.getElementById('recipe-search');
  const dropdown = document.getElementById('dropdown');
  input.addEventListener('input', () => {
    const q = input.value.toLowerCase().trim();
    const matches = q ? recipes.filter(r => r.name.toLowerCase().includes(q) || r.category.toLowerCase().includes(q)) : recipes;
    renderDropdown(matches);
    dropdown.classList.toggle('open', q.length > 0 && matches.length > 0);
  });
  input.addEventListener('focus', () => {
    if (!input.value) { renderDropdown(recipes); dropdown.classList.add('open'); }
  });
  document.addEventListener('click', e => {
    if (!e.target.closest('.search-results')) dropdown.classList.remove('open');
  });
}

function renderDropdown(list) {
  document.getElementById('dropdown').innerHTML = list.map(r => `
    <div class="dropdown-item" onclick="selectRecipe('${r.id}')">
      <div class="recipe-name">${r.name}</div>
      <div class="recipe-cat">${r.category}</div>
    </div>`).join('');
}

function selectRecipe(id) {
  currentRecipe = recipes.find(r => r.id === id);
  if (!currentRecipe) return;
  currentServings = currentRecipe.baseServings;
  document.getElementById('recipe-search').value = currentRecipe.name;
  document.getElementById('dropdown').classList.remove('open');
  renderRecipe();
}

// ‚îÄ‚îÄ‚îÄ Recipe Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRecipe() {
  const card = document.getElementById('recipe-card');
  const empty = document.getElementById('empty-state');
  if (!currentRecipe) return;
  empty.style.display = 'none';
  card.classList.add('visible');

  const groups = {};
  currentRecipe.ingredients.forEach(ing => {
    if (!groups[ing.usedIn]) groups[ing.usedIn] = [];
    groups[ing.usedIn].push(ing);
  });

  const ingHTML = Object.entries(groups).map(([group, ings]) => `
    <div class="ingredient-group">
      <div class="group-label">${group}</div>
      ${ings.map(ing => `
        <div class="ingredient-row">
          <span class="ing-amount">${formatAmount(ing, currentServings, currentRecipe.baseServings)}</span>
          <span class="ing-name">${ing.name}</span>
          ${ing.cut ? `<span class="ing-cut">(${ing.cut})</span>` : ''}
        </div>`).join('')}
    </div>`).join('');

  const stepsHTML = currentRecipe.directions.map((step, i) => `
    <div class="direction-step">
      <div class="step-num">${i+1}</div>
      <div class="step-text">${step}</div>
    </div>`).join('');

  card.innerHTML = `
    <div class="recipe-header">
      <div class="recipe-category">${currentRecipe.category}</div>
      <div class="recipe-title">${currentRecipe.name}</div>
      <div class="recipe-desc">${currentRecipe.description}</div>
      <div class="recipe-actions">
        <button class="btn-edit" onclick="openEditModal('${currentRecipe.id}')">‚úèÔ∏è Edit</button>
        <button class="btn-delete" onclick="openConfirm('${currentRecipe.id}')">üóë Delete</button>
      </div>
    </div>
    <div class="scaler-bar">
      <span class="scaler-label">Servings:</span>
      <div class="scaler-controls">
        <button class="scaler-btn" onclick="adjustServings(-1)">‚àí</button>
        <input type="number" id="serving-count" value="${currentServings}" min="1" onchange="setServings(this.value)" />
        <button class="scaler-btn" onclick="adjustServings(1)">+</button>
      </div>
      <span class="scaler-note">(base recipe makes ${currentRecipe.baseServings})</span>
    </div>
    <div class="recipe-body">
      <div class="ingredients-panel">
        <div class="panel-title">Ingredients</div>${ingHTML}
      </div>
      <div class="directions-panel">
        <div class="panel-title">Directions</div>${stepsHTML}
      </div>
    </div>
    ${currentRecipe.notes ? `<div class="recipe-notes"><strong>üìù Notes:</strong> ${currentRecipe.notes}</div>` : ''}`;
}

function adjustServings(delta) {
  currentServings = Math.max(1, currentServings + delta);
  document.getElementById('serving-count').value = currentServings;
  renderRecipe();
}
function setServings(val) {
  currentServings = Math.max(1, parseInt(val) || 1);
  renderRecipe();
}

// ‚îÄ‚îÄ‚îÄ Measurement Formatter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatAmount(ing, servings, baseServings) {
  const m = servings / baseServings;
  if (ing.unit === 'GARNISH') return 'to taste';

  if (ing.unit === 'PC') {
    const qty = Math.round(ing.baseTsp * m * 4) / 4;
    if (qty <= 0) return '‚Äî';
    return formatFraction(qty) + (qty === 1 ? ' piece' : ' pieces');
  }
  if (ing.unit === 'CL') {
    const qty = Math.round(ing.baseTsp * m);
    if (qty <= 0) return '‚Äî';
    return qty + (qty === 1 ? ' clove' : ' cloves');
  }
  if (ing.unit === 'PKG') {
    const qty = Math.round(ing.baseTsp * m * 4) / 4;
    if (qty <= 0) return '‚Äî';
    return formatFraction(qty) + (qty === 1 ? ' package' : ' packages');
  }
  if (ing.unit === 'LB') {
    return formatWeight(ing.baseTsp * m, 'lb');
  }
  if (ing.unit === 'OZ') {
    return formatWeight(ing.baseTsp * m, 'oz');
  }

  return formatVolume(ing.baseTsp * m);
}

function formatWeight(total, unit) {
  if (total <= 0) return '‚Äî';
  if (unit === 'oz') {
    // If 16oz or more, convert to lbs
    if (total >= 16) return formatWeight(total / 16, 'lb');
    const rounded = Math.round(total * 4) / 4;
    return formatFrac(rounded) + (rounded === 1 ? ' oz' : ' oz');
  }
  // Pounds
  const wholeLbs = Math.floor(total);
  const remOz = Math.round((total - wholeLbs) * 16);
  // Round to nearest common fraction of a lb: 0, ¬º, ‚Öì, ¬Ω, ‚Öî, ¬æ
  const lbFracs = [[0,''], [4,'¬º'], [5,'‚Öì'], [8,'¬Ω'], [11,'‚Öî'], [12,'¬æ'], [16,'NEXT']];
  const best = lbFracs.reduce((a, b) => Math.abs(b[0] - remOz) < Math.abs(a[0] - remOz) ? b : a);
  let whole = wholeLbs;
  let frac = best[1];
  if (frac === 'NEXT') { whole++; frac = ''; }
  const lbWord = (whole + (frac ? 0.5 : 0)) === 1 ? 'lb' : 'lbs';
  if (whole > 0 && frac) return `${whole} ${frac} ${lbWord}`;
  if (whole > 0) return `${whole} ${lbWord}`;
  if (frac) return `${frac} lb`;
  return '‚Äî';
}

function formatVolume(totalTsp) {
  if (totalTsp <= 0) return '‚Äî';

  // Cup fraction map: tsp value ‚Üí display string
  const cupFracs = [
    [0,  ''], [6, '‚Öõ'], [12, '¬º'], [16, '‚Öì'],
    [24, '¬Ω'], [32, '‚Öî'], [36, '¬æ'], [48, 'NEXT']
  ];

  if (totalTsp >= 12) {
    // Work in cups
    let wholeCups = Math.floor(totalTsp / 48);
    const remTsp = totalTsp % 48;
    // Find nearest cup fraction for remainder
    const best = cupFracs.reduce((a, b) =>
      Math.abs(b[0] - remTsp) < Math.abs(a[0] - remTsp) ? b : a
    );
    let fracStr = best[1];
    if (fracStr === 'NEXT') { wholeCups++; fracStr = ''; }
    const cupWord = (wholeCups + (fracStr ? 0.5 : 0)) === 1 ? 'cup' : 'cups';
    if (wholeCups > 0 && fracStr) return `${wholeCups} ${fracStr} ${cupWord}`;
    if (wholeCups > 0) return `${wholeCups} ${cupWord}`;
    if (fracStr) return `${fracStr} cup`;
  }

  if (totalTsp >= 3) {
    // Work in tablespoons
    const wholeTbsp = Math.floor(totalTsp / 3);
    const remTsp = Math.round((totalTsp % 3) * 2) / 2;
    const parts = [];
    if (wholeTbsp > 0) parts.push(wholeTbsp + ' tbsp');
    if (remTsp > 0) parts.push(formatFrac(remTsp) + ' tsp');
    return parts.join(' + ');
  }

  // Pure teaspoons - round to nearest 1/8 tsp
  const rounded = Math.round(totalTsp * 8) / 8;
  return rounded > 0 ? formatFrac(rounded) + ' tsp' : '‚Öõ tsp';
}

function formatFrac(num) {
  const whole = Math.floor(num);
  // Round to nearest 1/8
  const frac = Math.round((num - whole) * 8) / 8;
  const map = { 0.125:'‚Öõ', 0.25:'¬º', 0.375:'‚Öú', 0.5:'¬Ω', 0.625:'‚Öù', 0.75:'¬æ', 0.875:'‚Öû' };
  const fs = map[frac] || '';
  if (frac >= 1) return `${whole + 1}`; // rounds up to next whole
  if (whole > 0 && fs) return `${whole} ${fs}`;
  if (whole > 0) return `${whole}`;
  return fs || '0';
}

function formatFraction(num) { return formatFrac(num); }

// ‚îÄ‚îÄ‚îÄ Shopping List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPickList() {
  const container = document.getElementById('recipe-pick-list');
  container.innerHTML = recipes.map(r => `
    <div class="recipe-pick-row" id="pick-row-${r.id}">
      <input type="checkbox" class="pick-checkbox" id="pick-${r.id}"
        onchange="togglePickRow('${r.id}')" />
      <span class="pick-name" onclick="document.getElementById('pick-${r.id}').click()">${r.name}</span>
      <span class="pick-cat">${r.category}</span>
      <div class="pick-servings-ctrl">
        <label>Servings:</label>
        <input type="number" class="pick-servings-input" id="pick-srv-${r.id}"
          value="${r.baseServings}" min="1" />
      </div>
    </div>`).join('');
}

function togglePickRow(id) {
  const checked = document.getElementById('pick-' + id).checked;
  document.getElementById('pick-row-' + id).classList.toggle('selected', checked);
}

function generateShoppingList() {
  const selected = recipes.filter(r => document.getElementById('pick-' + r.id)?.checked);
  if (selected.length === 0) { alert('Please select at least one recipe.'); return; }

  // Combine ingredients by name + unit
  const combined = {};
  selected.forEach(r => {
    const servings = parseInt(document.getElementById('pick-srv-' + r.id)?.value) || r.baseServings;
    const multiplier = servings / r.baseServings;
    r.ingredients.forEach(ing => {
      if (ing.unit === 'GARNISH') {
        const key = ing.name + '__GARNISH';
        if (!combined[key]) combined[key] = { ...ing, recipes: [], totalTsp: 0, isGarnish: true };
        combined[key].recipes.push(r.name);
        return;
      }
      const key = ing.name + '__' + ing.unit;
      if (!combined[key]) {
        combined[key] = { ...ing, recipes: [], totalTsp: 0, totalQty: 0 };
      }
      combined[key].recipes.push(r.name);
      if (ing.unit === 'V') combined[key].totalTsp += ing.baseTsp * multiplier;
      else combined[key].totalQty += ing.baseTsp * multiplier;
      combined[key].unit = ing.unit;
    });
  });

  // Group by grocery category
  const byCategory = {};
  Object.values(combined).forEach(item => {
    const cat = item.groceryCategory || 'Other';
    if (!byCategory[cat]) byCategory[cat] = [];
    byCategory[cat].push(item);
  });

  // Render
  const output = document.getElementById('shopping-list-output');
  const groups = document.getElementById('grocery-groups');
  output.classList.add('visible');

  groups.innerHTML = CATEGORY_ORDER
    .filter(cat => byCategory[cat])
    .map(cat => {
      const items = byCategory[cat].sort((a,b) => a.name.localeCompare(b.name));
      return `
        <div class="grocery-category">
          <div class="cat-header">
            <span class="cat-icon">${CATEGORY_ICONS[cat] || 'üõí'}</span>
            <span class="cat-name">${cat}</span>
            <span class="cat-count">${items.length} item${items.length !== 1 ? 's' : ''}</span>
          </div>
          ${items.map((item, idx) => {
            const amt = item.isGarnish ? 'to taste' :
              item.unit === 'V' ? formatAmount({...item, baseTsp: item.totalTsp}, 1, 1) :
              item.unit === 'CL' ? Math.round(item.totalQty) + (Math.round(item.totalQty) === 1 ? ' clove' : ' cloves') :
              item.unit === 'LB' ? formatWeight(item.totalQty, 'lb') :
              item.unit === 'OZ' ? formatWeight(item.totalQty, 'oz') :
              item.unit === 'PKG' ? formatFraction(Math.round(item.totalQty * 4)/4) + (Math.round(item.totalQty * 4)/4 === 1 ? ' package' : ' packages') :
              formatFraction(Math.round(item.totalQty * 4)/4) + (Math.round(item.totalQty * 4)/4 === 1 ? ' piece' : ' pieces');
            const recipeList = [...new Set(item.recipes)].join(', ');
            return `
              <div class="shop-item" id="shop-item-${cat}-${idx}" onclick="toggleCheck('shop-item-${cat}-${idx}')">
                <input type="checkbox" class="shop-check" onclick="event.stopPropagation(); toggleCheck('shop-item-${cat}-${idx}')" />
                <span class="shop-amount">${amt}</span>
                <div style="flex:1">
                  <div class="shop-name">${item.name}${item.cut ? ` <span style="font-style:italic;font-size:0.8rem;color:var(--brown-mid)">(${item.cut})</span>` : ''}</div>
                  <div class="shop-recipes">for: ${recipeList}</div>
                </div>
              </div>`;
          }).join('')}
        </div>`;
    }).join('');

  output.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleCheck(id) {
  const el = document.getElementById(id);
  el.classList.toggle('checked');
  const cb = el.querySelector('.shop-check');
  if (cb) cb.checked = el.classList.contains('checked');
}

function uncheckAll() {
  document.querySelectorAll('.shop-item').forEach(el => {
    el.classList.remove('checked');
    const cb = el.querySelector('.shop-check');
    if (cb) cb.checked = false;
  });
}

function copyList() {
  const lines = [];
  document.querySelectorAll('.grocery-category').forEach(cat => {
    const name = cat.querySelector('.cat-name').textContent;
    lines.push(`\n‚îÄ‚îÄ ${name} ‚îÄ‚îÄ`);
    cat.querySelectorAll('.shop-item').forEach(item => {
      const checked = item.classList.contains('checked') ? '‚úì ' : '‚òê ';
      const amt = item.querySelector('.shop-amount').textContent;
      const iname = item.querySelector('.shop-name').childNodes[0].textContent.trim();
      lines.push(`${checked}${amt}  ${iname}`);
    });
  });
  navigator.clipboard.writeText(lines.join('\n').trim())
    .then(() => alert('Shopping list copied to clipboard!'))
    .catch(() => alert('Could not copy ‚Äî try selecting and copying manually.'));
}

// ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
  document.getElementById('modal-title').textContent = 'Add New Recipe';
  document.getElementById('f-edit-id').value = '';
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-status').className = 'status-msg';
}

function openEditModal(id) {
  const r = recipes.find(r => r.id === id);
  if (!r) return;
  document.getElementById('modal-title').textContent = 'Edit Recipe';
  document.getElementById('f-edit-id').value = r.id;
  document.getElementById('f-name').value = r.name;
  document.getElementById('f-category').value = r.category;
  document.getElementById('f-desc').value = r.description || '';
  document.getElementById('f-servings').value = r.baseServings;
  document.getElementById('f-ingredients').value = r.ingredients.map(i =>
    `${i.name} | ${i.baseTsp} | ${i.unit} | ${i.cut || ''} | ${i.usedIn} | ${i.groceryCategory || ''}`
  ).join('\n');
  document.getElementById('f-directions').value = r.directions.join('\n');
  document.getElementById('f-notes').value = r.notes || '';
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-status').className = 'status-msg';
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  ['f-edit-id','f-name','f-category','f-desc','f-servings','f-ingredients','f-directions','f-notes']
    .forEach(id => document.getElementById(id).value = '');
}

function openConfirm(id) {
  document.getElementById('confirm-overlay').dataset.deleteId = id;
  const r = recipes.find(r => r.id === id);
  document.getElementById('confirm-msg').textContent =
    `Are you sure you want to delete "${r ? r.name : 'this recipe'}"? This cannot be undone.`;
  document.getElementById('confirm-overlay').classList.add('open');
}

function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('open');
}

async function confirmDelete() {
  const id = document.getElementById('confirm-overlay').dataset.deleteId;
  recipes = recipes.filter(r => r.id !== id);
  closeConfirm();
  currentRecipe = null;
  document.getElementById('recipe-card').classList.remove('visible');
  document.getElementById('recipe-search').value = '';
  document.getElementById('empty-state').style.display = '';
  initSearch();
  if (githubConfig.owner && githubConfig.repo && githubConfig.token) {
    const saved = await saveToGitHub(recipes);
    if (!saved) alert('Removed locally but GitHub save failed.');
  }
}

async function saveRecipe() {
  const name    = document.getElementById('f-name').value.trim();
  const cat     = document.getElementById('f-category').value.trim();
  const desc    = document.getElementById('f-desc').value.trim();
  const base    = parseInt(document.getElementById('f-servings').value) || 4;
  const ingRaw  = document.getElementById('f-ingredients').value.trim();
  const dirRaw  = document.getElementById('f-directions').value.trim();
  const notes   = document.getElementById('f-notes').value.trim();
  const editId  = document.getElementById('f-edit-id').value;

  if (!name || !ingRaw || !dirRaw) {
    showStatus('Please fill in name, ingredients, and directions.', 'error'); return;
  }

  const ingredients = ingRaw.split('\n').filter(Boolean).map(line => {
    const parts = line.split('|').map(s => s.trim());
    return {
      name: parts[0], baseTsp: parseFloat(parts[1]) || 0, unit: parts[2] || 'V',
      cut: parts[3] || '', usedIn: parts[4] || 'Main', groceryCategory: parts[5] || 'Pantry'
    };
  });

  const directions = dirRaw.split('\n').filter(Boolean);
  const id = editId || name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  const newRecipe = { id, name, category: cat, baseServings: base, description: desc, ingredients, directions, notes };

  const existing = recipes.findIndex(r => r.id === id);
  if (existing >= 0) recipes[existing] = newRecipe;
  else recipes.push(newRecipe);

  if (githubConfig.owner && githubConfig.repo && githubConfig.token) {
    const saved = await saveToGitHub(recipes);
    showStatus(saved ? 'Saved to GitHub! ‚úì' : 'Saved locally but GitHub save failed.', saved ? 'success' : 'error');
  } else {
    showStatus('Added locally. Set up GitHub config to save permanently.', 'success');
  }

  recipes.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
  initSearch();
  renderPickList();
  setTimeout(() => { closeModal(); selectRecipe(id); showView('recipes'); }, 1200);
}

async function saveToGitHub(recipesData) {
  try {
    const { owner, repo, token } = githubConfig;
    const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents/recipes.json`;
    const getRes = await fetch(apiBase, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    const { sha } = await getRes.json();
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(recipesData, null, 2))));
    const putRes = await fetch(apiBase, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `Update recipes`, content, sha })
    });
    return putRes.ok;
  } catch(e) { return false; }
}

function showStatus(msg, type) {
  const el = document.getElementById('modal-status');
  el.textContent = msg;
  el.className = `status-msg ${type}`;
}
</script>
</body>
</html>